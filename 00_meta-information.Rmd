# Meta information
There should be here the libraries, dataset, odk and sampling frame and any other thing.


```{r}
## Importing dataset and questionnaire 
library(magrittr)
library(dplyr)
library(readxl)
library(hypegrammaR)

main_dataset <- read.csv("inputs/UKR2007_MSNA20_HH_dataset_main_rcop.csv", na.strings = "")
loop_dataset <- read.csv("inputs/UKR2007_MSNA20_HH_dataset_loop_rcop.csv", na.strings = "")

questions <- read_xlsx("inputs/UKR2007_MSNA20_HH_Questionnaire_24JUL2020.xlsx",sheet="survey")
choices <- read_xlsx("inputs/UKR2007_MSNA20_HH_Questionnaire_24JUL2020.xlsx",sheet="choices")

```

Note that some variables were NA'ed (age, etc.) In addition, it seems the weights are already added, and both loops where combined already.

## Creating the questionnaire object

```{r, tidy=FALSE, warning=FALSE, results='hide', message=FALSE}

main_dataset <- main_dataset %>% select_if(~ !(all(is.na(.x)) | all(. == "")))

questionnaire <- load_questionnaire(data = main_dataset,
                                    questions = questions,
                                    choices = choices,
                                    choices.label.column.to.use = "label::English")

```

Probably which packages are used and version


## Downloading Audit files from API
Required Libraries: httr

****

"download_audit_files" will download audit files using the endpoint that is included in your data set called "audit_URL". It will create a folder named by the uuid of each form/interview, and the audit.csv inside it. The advantage of using the API over downloading manually is that you can download the audit files of each form that has recently been submitted to the server separately, rather than downloading cumulatively the whole audit files each time.

```{r}
download_audit_files <- function(df, uuid_column = "_uuid", audit_dir, usr, pass){
  # checking if the output directory is already available
  if (!dir.exists(output_dir)) {
    dir.create(output_dir)
    if (dir.exists(output_dir)) {
      cat("Attention: The audit file directory was created in", output_dir,"\n")
    }
  }
  
  # checking if creating output directory was successful
  if (!dir.exists(output_dir))
    stop("download_audit_fils was not able to create the output directory!")
  # checking if uuid column exists in data set
  if (!uuid_col %in% names(my_df))
    stop("The column ", uuid_col, " is not available in data set.")
  # checking if column audit_URL exists in data set
  if (!uuid_col %in% names(my_df))
    stop("The column ", uuid_col, " is not available in data set.")
  if (!"audit_URL" %in% names(my_df))
    stop("Error: the column audit_URL is not available in data set.")
  
  # getting the list of uuids that are already downloaded
  available_audits <- dir(audit_dir)
  
  # excluding uuids that their audit files are already downloaded
  df <- df[!df[[uuid_col]] %in% available_audits,]
  
  audits_endpoint_link <- df[["audit_URL"]]
  names(audits_endpoint_link) <- df[[uuid_col]]
  audits_endpoint_link <- na.omit(audits_endpoint_link)
  
  # iterating over each audit endpoint from data
  for (i in 1:length(audits_endpoint_link)) {
    uuid = names(audits_endpoint_link[i])
    endpoint_link_i <- audits_endpoint_link[i]
    cat("Downloading audit file for", uuid, "\n")
    
    # requesting data
    audit_file <- content(GET(endpoint_link_i,
                        authenticate(usr, pass),
                        timeout(1000),
                        progress()), "text", encoding = "UTF-8")
    
    if (!is.na(audit_file)) {
      if (length(audit_file) > 2) {
        dir.create(paste0(output_dir, "/", uuid), showWarnings = F)
        write.csv(audit_file, paste0(output_dir, "/", uuid, "/audit.csv"), row.names = F)
      }else if(!audit_file == "Attachment not found"){
        if (grepl("[eventnodestartend]", audit_file)) {
          dir.create(paste0(output_dir, "/", uuid), showWarnings = F)
          write.table(audit_file, paste0(output_dir, "/", uuid, "/audit.csv"), row.names = F, col.names = FALSE, quote = F)
        } else{
          cat("Error: Downloading audit was unsucessful!\n")
        }
      }
    } else{
      cat("Error: Downloading audit was unsucessful!\n")
    }
  }
}

```
